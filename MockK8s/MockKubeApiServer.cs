using System;
using System.IO;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using Microsoft.AspNetCore;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Hosting.Server.Features;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Server.Kestrel.Core;
using Microsoft.Extensions.Logging;
using Xunit.Abstractions;

namespace MockK8s
{
    public sealed class MockKubeApiServer : IDisposable
    {
        // paste from minikube /api/v1/namespaces/default/pods
        public const string MockPodResponse =
            "{\r\n  \"kind\": \"PodList\",\r\n  \"apiVersion\": \"v1\",\r\n  \"metadata\": {\r\n    \"selfLink\": \"/api/v1/namespaces/default/pods\",\r\n    \"resourceVersion\": \"1762810\"\r\n  },\r\n  \"items\": [\r\n    {\r\n      \"metadata\": {\r\n        \"name\": \"nginx-1493591563-xb2v4\",\r\n        \"generateName\": \"nginx-1493591563-\",\r\n        \"namespace\": \"default\",\r\n        \"selfLink\": \"/api/v1/namespaces/default/pods/nginx-1493591563-xb2v4\",\r\n        \"uid\": \"ac1abb94-9c58-11e7-aaf5-00155d744505\",\r\n        \"resourceVersion\": \"1737928\",\r\n        \"creationTimestamp\": \"2017-09-18T10:03:51Z\",\r\n        \"labels\": {\r\n          \"app\": \"nginx\",\r\n          \"pod-template-hash\": \"1493591563\"\r\n        },\r\n        \"annotations\": {\r\n          \"kubernetes.io/created-by\": \"{\\\"kind\\\":\\\"SerializedReference\\\",\\\"apiVersion\\\":\\\"v1\\\",\\\"reference\\\":{\\\"kind\\\":\\\"ReplicaSet\\\",\\\"namespace\\\":\\\"default\\\",\\\"name\\\":\\\"nginx-1493591563\\\",\\\"uid\\\":\\\"ac013b63-9c58-11e7-aaf5-00155d744505\\\",\\\"apiVersion\\\":\\\"extensions\\\",\\\"resourceVersion\\\":\\\"5306\\\"}}\\n\"\r\n        },\r\n        \"ownerReferences\": [\r\n          {\r\n            \"apiVersion\": \"extensions/v1beta1\",\r\n            \"kind\": \"ReplicaSet\",\r\n            \"name\": \"nginx-1493591563\",\r\n            \"uid\": \"ac013b63-9c58-11e7-aaf5-00155d744505\",\r\n            \"controller\": true,\r\n            \"blockOwnerDeletion\": true\r\n          }\r\n        ]\r\n      },\r\n      \"spec\": {\r\n        \"volumes\": [\r\n          {\r\n            \"name\": \"default-token-3zzcj\",\r\n            \"secret\": {\r\n              \"secretName\": \"default-token-3zzcj\",\r\n              \"defaultMode\": 420\r\n            }\r\n          }\r\n        ],\r\n        \"containers\": [\r\n          {\r\n            \"name\": \"nginx\",\r\n            \"image\": \"nginx\",\r\n            \"resources\": {},\r\n            \"volumeMounts\": [\r\n              {\r\n                \"name\": \"default-token-3zzcj\",\r\n                \"readOnly\": true,\r\n                \"mountPath\": \"/var/run/secrets/kubernetes.io/serviceaccount\"\r\n              }\r\n            ],\r\n            \"terminationMessagePath\": \"/dev/termination-log\",\r\n            \"terminationMessagePolicy\": \"File\",\r\n            \"imagePullPolicy\": \"Always\"\r\n          }\r\n        ],\r\n        \"restartPolicy\": \"Always\",\r\n        \"terminationGracePeriodSeconds\": 30,\r\n        \"dnsPolicy\": \"ClusterFirst\",\r\n        \"serviceAccountName\": \"default\",\r\n        \"serviceAccount\": \"default\",\r\n        \"nodeName\": \"ubuntu\",\r\n        \"securityContext\": {},\r\n        \"schedulerName\": \"default-scheduler\"\r\n      },\r\n      \"status\": {\r\n        \"phase\": \"Running\",\r\n        \"conditions\": [\r\n          {\r\n            \"type\": \"Initialized\",\r\n            \"status\": \"True\",\r\n            \"lastProbeTime\": null,\r\n            \"lastTransitionTime\": \"2017-09-18T10:03:51Z\"\r\n          },\r\n          {\r\n            \"type\": \"Ready\",\r\n            \"status\": \"True\",\r\n            \"lastProbeTime\": null,\r\n            \"lastTransitionTime\": \"2017-10-12T07:09:21Z\"\r\n          },\r\n          {\r\n            \"type\": \"PodScheduled\",\r\n            \"status\": \"True\",\r\n            \"lastProbeTime\": null,\r\n            \"lastTransitionTime\": \"2017-09-18T10:03:51Z\"\r\n          }\r\n        ],\r\n        \"hostIP\": \"192.168.188.42\",\r\n        \"podIP\": \"172.17.0.5\",\r\n        \"startTime\": \"2017-09-18T10:03:51Z\",\r\n        \"containerStatuses\": [\r\n          {\r\n            \"name\": \"nginx\",\r\n            \"state\": {\r\n              \"running\": {\r\n                \"startedAt\": \"2017-10-12T07:09:20Z\"\r\n              }\r\n            },\r\n            \"lastState\": {\r\n              \"terminated\": {\r\n                \"exitCode\": 0,\r\n                \"reason\": \"Completed\",\r\n                \"startedAt\": \"2017-10-10T21:35:51Z\",\r\n                \"finishedAt\": \"2017-10-12T07:07:37Z\",\r\n                \"containerID\": \"docker://94df3f3965807421ad6dc76618e00b76cb15d024919c4946f3eb46a92659c62a\"\r\n              }\r\n            },\r\n            \"ready\": true,\r\n            \"restartCount\": 7,\r\n            \"image\": \"nginx:latest\",\r\n            \"imageID\": \"docker-pullable://nginx@sha256:004ac1d5e791e705f12a17c80d7bb1e8f7f01aa7dca7deee6e65a03465392072\",\r\n            \"containerID\": \"docker://fa11bdd48c9b7d3a6c4c3f9b6d7319743c3455ab8d00c57d59c083b319b88194\"\r\n          }\r\n        ],\r\n        \"qosClass\": \"BestEffort\"\r\n      }\r\n    }\r\n  ]\r\n}";

        // paste from an AKS cluster
        public const string MockDeploymentReponse =
            "{\"ApiVersion\":\"apps/v1\",\"Kind\":\"Deployment\",\"Metadata\":{\"Annotations\":{\"deployment.kubernetes.io/revision\":\"1\",\"kubectl.kubernetes.io/last-applied-configuration\":\"{\u0022apiVersion\u0022:\u0022apps/v1\u0022,\u0022kind\u0022:\u0022Deployment\u0022,\u0022metadata\u0022:{\u0022annotations\u0022:{},\u0022labels\u0022:{\u0022addonmanager.kubernetes.io/mode\u0022:\u0022Reconcile\u0022,\u0022k8s-app\u0022:\u0022metrics-server\u0022,\u0022kubernetes.io/cluster-service\u0022:\u0022true\u0022},\u0022name\u0022:\u0022metrics-server\u0022,\u0022namespace\u0022:\u0022kube-system\u0022},\u0022spec\u0022:{\u0022paused\u0022:false,\u0022revisionHistoryLimit\u0022:2,\u0022selector\u0022:{\u0022matchLabels\u0022:{\u0022k8s-app\u0022:\u0022metrics-server\u0022}},\u0022template\u0022:{\u0022metadata\u0022:{\u0022labels\u0022:{\u0022k8s-app\u0022:\u0022metrics-server\u0022},\u0022name\u0022:\u0022metrics-server\u0022},\u0022spec\u0022:{\u0022affinity\u0022:{\u0022nodeAffinity\u0022:{\u0022preferredDuringSchedulingIgnoredDuringExecution\u0022:[{\u0022preference\u0022:{\u0022matchExpressions\u0022:[{\u0022key\u0022:\u0022kubernetes.azure.com/mode\u0022,\u0022operator\u0022:\u0022In\u0022,\u0022values\u0022:[\u0022system\u0022]}]},\u0022weight\u0022:100}],\u0022requiredDuringSchedulingIgnoredDuringExecution\u0022:{\u0022nodeSelectorTerms\u0022:[{\u0022labelSelector\u0022:null,\u0022matchExpressions\u0022:[{\u0022key\u0022:\u0022kubernetes.azure.com/cluster\u0022,\u0022operator\u0022:\u0022Exists\u0022}]}]}}},\u0022containers\u0022:[{\u0022command\u0022:[\u0022/metrics-server\u0022,\u0022--kubelet-insecure-tls\u0022,\u0022--kubelet-preferred-address-types=InternalIP\u0022,\u0022--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\u0022],\u0022image\u0022:\u0022mcr.microsoft.com/oss/kubernetes/metrics-server:v0.3.6\u0022,\u0022imagePullPolicy\u0022:\u0022IfNotPresent\u0022,\u0022livenessProbe\u0022:{\u0022failureThreshold\u0022:3,\u0022httpGet\u0022:{\u0022path\u0022:\u0022/healthz\u0022,\u0022port\u0022:443,\u0022scheme\u0022:\u0022HTTPS\u0022},\u0022initialDelaySeconds\u0022:20,\u0022periodSeconds\u0022:10,\u0022successThreshold\u0022:1,\u0022timeoutSeconds\u0022:1},\u0022name\u0022:\u0022metrics-server\u0022,\u0022readinessProbe\u0022:{\u0022failureThreshold\u0022:3,\u0022httpGet\u0022:{\u0022path\u0022:\u0022/healthz\u0022,\u0022port\u0022:443,\u0022scheme\u0022:\u0022HTTPS\u0022},\u0022initialDelaySeconds\u0022:20,\u0022periodSeconds\u0022:10,\u0022successThreshold\u0022:1,\u0022timeoutSeconds\u0022:1},\u0022resources\u0022:{\u0022limits\u0022:{\u0022cpu\u0022:1,\u0022memory\u0022:\u00222000Mi\u0022},\u0022requests\u0022:{\u0022cpu\u0022:\u002244m\u0022,\u0022memory\u0022:\u002255Mi\u0022}}}],\u0022nodeSelector\u0022:{\u0022beta.kubernetes.io/os\u0022:\u0022linux\u0022},\u0022priorityClassName\u0022:\u0022system-node-critical\u0022,\u0022serviceAccountName\u0022:\u0022metrics-server\u0022,\u0022tolerations\u0022:[{\u0022key\u0022:\u0022CriticalAddonsOnly\u0022,\u0022operator\u0022:\u0022Exists\u0022},{\u0022effect\u0022:\u0022NoExecute\u0022,\u0022key\u0022:\u0022node.kubernetes.io/unreachable\u0022,\u0022operator\u0022:\u0022Exists\u0022,\u0022tolerationSeconds\u0022:30},{\u0022effect\u0022:\u0022NoExecute\u0022,\u0022key\u0022:\u0022node.kubernetes.io/not-ready\u0022,\u0022operator\u0022:\u0022Exists\u0022,\u0022tolerationSeconds\u0022:30}]}}}}\n\"},\"ClusterName\":null,\"CreationTimestamp\":\"2021-11-07T01:32:42Z\",\"DeletionGracePeriodSeconds\":null,\"DeletionTimestamp\":null,\"Finalizers\":null,\"GenerateName\":null,\"Generation\":1,\"Labels\":{\"addonmanager.kubernetes.io/mode\":\"Reconcile\",\"k8s-app\":\"metrics-server\",\"kubernetes.io/cluster-service\":\"true\"},\"ManagedFields\":[{\"ApiVersion\":\"apps/v1\",\"FieldsType\":\"FieldsV1\",\"FieldsV1\":{\"f:metadata\":[[[[[]],[[]]]],[[[[]],[[]],[[]],[[]]]]],\"f:spec\":[[[]],[[]],[[]],[[]],[[[[[[]],[[]],[[]]]],[[]]]],[[[[[[[[]],[[]]]],[[]]]],[[[[[[]],[[[[]],[[]],[[[[]],[[]]]]]]]],[[[[[[]],[[]],[[]],[[]],[[[[]],[[]],[[[[]],[[]],[[]],[[]]]],[[]],[[]],[[]],[[]]]],[[]],[[[[]],[[]],[[[[]],[[]],[[]],[[]]]],[[]],[[]],[[]],[[]]]],[[[[]],[[[[]],[[]],[[]]]],[[[[]],[[]],[[]]]]]],[[]],[[]]]]]],[[]],[[[[]],[[]]]],[[]],[[]],[[]],[[]],[[]],[[]],[[]],[[]]]]]]]},\"Manager\":\"kubectl-client-side-apply\",\"Operation\":\"Update\",\"Subresource\":null,\"Time\":\"2021-11-07T01:32:42Z\"},{\"ApiVersion\":\"apps/v1\",\"FieldsType\":\"FieldsV1\",\"FieldsV1\":{\"f:metadata\":[[[[[]]]]],\"f:status\":[[[]],[[[[]],[[[[]],[[]],[[]],[[]],[[]],[[]],[[]]]],[[[[]],[[]],[[]],[[]],[[]],[[]],[[]]]]]],[[]],[[]],[[]],[[]]]},\"Manager\":\"kube-controller-manager\",\"Operation\":\"Update\",\"Subresource\":null,\"Time\":\"2021-11-07T01:39:06Z\"}],\"Name\":\"metrics-server\",\"NamespaceProperty\":\"kube-system\",\"OwnerReferences\":null,\"ResourceVersion\":\"1217\",\"SelfLink\":null,\"Uid\":\"715e3ccc-72d0-4dcd-aba7-90f8ef1b04a8\"},\"Spec\":{\"MinReadySeconds\":null,\"Paused\":null,\"ProgressDeadlineSeconds\":600,\"Replicas\":1,\"RevisionHistoryLimit\":2,\"Selector\":{\"MatchExpressions\":null,\"MatchLabels\":{\"k8s-app\":\"metrics-server\"}},\"Strategy\":{\"RollingUpdate\":{\"MaxSurge\":{\"Value\":\"25%\"},\"MaxUnavailable\":{\"Value\":\"25%\"}},\"Type\":\"RollingUpdate\"},\"Template\":{\"Metadata\":{\"Annotations\":null,\"ClusterName\":null,\"CreationTimestamp\":null,\"DeletionGracePeriodSeconds\":null,\"DeletionTimestamp\":null,\"Finalizers\":null,\"GenerateName\":null,\"Generation\":null,\"Labels\":{\"k8s-app\":\"metrics-server\"},\"ManagedFields\":null,\"Name\":\"metrics-server\",\"NamespaceProperty\":null,\"OwnerReferences\":null,\"ResourceVersion\":null,\"SelfLink\":null,\"Uid\":null},\"Spec\":{\"ActiveDeadlineSeconds\":null,\"Affinity\":{\"NodeAffinity\":{\"PreferredDuringSchedulingIgnoredDuringExecution\":[{\"Preference\":{\"MatchExpressions\":[{\"Key\":\"kubernetes.azure.com/mode\",\"OperatorProperty\":\"In\",\"Values\":[\"system\"]}],\"MatchFields\":null},\"Weight\":100}],\"RequiredDuringSchedulingIgnoredDuringExecution\":{\"NodeSelectorTerms\":[{\"MatchExpressions\":[{\"Key\":\"kubernetes.azure.com/cluster\",\"OperatorProperty\":\"Exists\",\"Values\":null}],\"MatchFields\":null}]}},\"PodAffinity\":null,\"PodAntiAffinity\":null},\"AutomountServiceAccountToken\":null,\"Containers\":[{\"Args\":null,\"Command\":[\"/metrics-server\",\"--kubelet-insecure-tls\",\"--kubelet-preferred-address-types=InternalIP\",\"--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\"],\"Env\":null,\"EnvFrom\":null,\"Image\":\"mcr.microsoft.com/oss/kubernetes/metrics-server:v0.3.6\",\"ImagePullPolicy\":\"IfNotPresent\",\"Lifecycle\":null,\"LivenessProbe\":{\"Exec\":null,\"FailureThreshold\":3,\"HttpGet\":{\"Host\":null,\"HttpHeaders\":null,\"Path\":\"/healthz\",\"Port\":{\"Value\":\"443\"},\"Scheme\":\"HTTPS\"},\"InitialDelaySeconds\":20,\"PeriodSeconds\":10,\"SuccessThreshold\":1,\"TcpSocket\":null,\"TerminationGracePeriodSeconds\":null,\"TimeoutSeconds\":1},\"Name\":\"metrics-server\",\"Ports\":null,\"ReadinessProbe\":{\"Exec\":null,\"FailureThreshold\":3,\"HttpGet\":{\"Host\":null,\"HttpHeaders\":null,\"Path\":\"/healthz\",\"Port\":{\"Value\":\"443\"},\"Scheme\":\"HTTPS\"},\"InitialDelaySeconds\":20,\"PeriodSeconds\":10,\"SuccessThreshold\":1,\"TcpSocket\":null,\"TerminationGracePeriodSeconds\":null,\"TimeoutSeconds\":1},\"Resources\":{\"Limits\":{\"cpu\":{\"Value\":\"1\",\"Format\":1},\"memory\":{\"Value\":\"2000Mi\",\"Format\":1}},\"Requests\":{\"cpu\":{\"Value\":\"44m\",\"Format\":1},\"memory\":{\"Value\":\"55Mi\",\"Format\":1}}},\"SecurityContext\":null,\"StartupProbe\":null,\"Stdin\":null,\"StdinOnce\":null,\"TerminationMessagePath\":\"/dev/termination-log\",\"TerminationMessagePolicy\":\"File\",\"Tty\":null,\"VolumeDevices\":null,\"VolumeMounts\":null,\"WorkingDir\":null}],\"DnsConfig\":null,\"DnsPolicy\":\"ClusterFirst\",\"EnableServiceLinks\":null,\"EphemeralContainers\":null,\"HostAliases\":null,\"HostIPC\":null,\"HostNetwork\":null,\"HostPID\":null,\"Hostname\":null,\"ImagePullSecrets\":null,\"InitContainers\":null,\"NodeName\":null,\"NodeSelector\":{\"beta.kubernetes.io/os\":\"linux\"},\"Overhead\":null,\"PreemptionPolicy\":null,\"Priority\":null,\"PriorityClassName\":\"system-node-critical\",\"ReadinessGates\":null,\"RestartPolicy\":\"Always\",\"RuntimeClassName\":null,\"SchedulerName\":\"default-scheduler\",\"SecurityContext\":{\"FsGroup\":null,\"FsGroupChangePolicy\":null,\"RunAsGroup\":null,\"RunAsNonRoot\":null,\"RunAsUser\":null,\"SeLinuxOptions\":null,\"SeccompProfile\":null,\"SupplementalGroups\":null,\"Sysctls\":null,\"WindowsOptions\":null},\"ServiceAccount\":\"metrics-server\",\"ServiceAccountName\":\"metrics-server\",\"SetHostnameAsFQDN\":null,\"ShareProcessNamespace\":null,\"Subdomain\":null,\"TerminationGracePeriodSeconds\":30,\"Tolerations\":[{\"Effect\":null,\"Key\":\"CriticalAddonsOnly\",\"OperatorProperty\":\"Exists\",\"TolerationSeconds\":null,\"Value\":null},{\"Effect\":\"NoExecute\",\"Key\":\"node.kubernetes.io/unreachable\",\"OperatorProperty\":\"Exists\",\"TolerationSeconds\":30,\"Value\":null},{\"Effect\":\"NoExecute\",\"Key\":\"node.kubernetes.io/not-ready\",\"OperatorProperty\":\"Exists\",\"TolerationSeconds\":30,\"Value\":null}],\"TopologySpreadConstraints\":null,\"Volumes\":null}}},\"Status\":{\"AvailableReplicas\":1,\"CollisionCount\":null,\"Conditions\":[{\"LastTransitionTime\":\"2021-11-07T01:39:06Z\",\"LastUpdateTime\":\"2021-11-07T01:39:06Z\",\"Message\":\"Deployment has minimum availability.\",\"Reason\":\"MinimumReplicasAvailable\",\"Status\":\"True\",\"Type\":\"Available\"},{\"LastTransitionTime\":\"2021-11-07T01:32:42Z\",\"LastUpdateTime\":\"2021-11-07T01:39:06Z\",\"Message\":\"ReplicaSet \u0022metrics-server-569f6547dd\u0022 has successfully progressed.\",\"Reason\":\"NewReplicaSetAvailable\",\"Status\":\"True\",\"Type\":\"Progressing\"}],\"ObservedGeneration\":1,\"ReadyReplicas\":1,\"Replicas\":1,\"UnavailableReplicas\":null,\"UpdatedReplicas\":1}}";

        public const string MockNamespaceResponse =
            "{\"ApiVersion\":\"v1\",\"Kind\":\"Namespace\",\"Metadata\":{\"Annotations\":{\"kubectl.kubernetes.io/last-applied-configuration\":\"{\u0022apiVersion\u0022:\u0022v1\u0022,\u0022kind\u0022:\u0022Namespace\u0022,\u0022metadata\u0022:{\u0022annotations\u0022:{},\u0022labels\u0022:{\u0022addonmanager.kubernetes.io/mode\u0022:\u0022Reconcile\u0022,\u0022control-plane\u0022:\u0022true\u0022,\u0022kubernetes.io/cluster-service\u0022:\u0022true\u0022},\u0022name\u0022:\u0022kube-system\u0022}}\n\"},\"ClusterName\":null,\"CreationTimestamp\":\"2021-11-07T01:32:04Z\",\"DeletionGracePeriodSeconds\":null,\"DeletionTimestamp\":null,\"Finalizers\":null,\"GenerateName\":null,\"Generation\":null,\"Labels\":{\"addonmanager.kubernetes.io/mode\":\"Reconcile\",\"control-plane\":\"true\",\"kubernetes.io/cluster-service\":\"true\"},\"ManagedFields\":[{\"ApiVersion\":\"v1\",\"FieldsType\":\"FieldsV1\",\"FieldsV1\":{\"f:status\":[[[]]]},\"Manager\":\"kube-apiserver\",\"Operation\":\"Update\",\"Subresource\":null,\"Time\":\"2021-11-07T01:32:04Z\"},{\"ApiVersion\":\"v1\",\"FieldsType\":\"FieldsV1\",\"FieldsV1\":{\"f:metadata\":[[[[[]],[[]]]],[[[[]],[[]],[[]],[[]]]]]},\"Manager\":\"kubectl-client-side-apply\",\"Operation\":\"Update\",\"Subresource\":null,\"Time\":\"2021-11-07T01:32:42Z\"}],\"Name\":\"kube-system\",\"NamespaceProperty\":null,\"OwnerReferences\":null,\"ResourceVersion\":\"431\",\"SelfLink\":null,\"Uid\":\"e1951099-cc21-4b39-9022-13d10a27e4b8\"},\"Spec\":{\"Finalizers\":[\"kubernetes\"]},\"Status\":{\"Conditions\":null,\"Phase\":\"Active\"}}";

        private readonly IWebHost _webHost;

        public MockKubeApiServer(ITestOutputHelper testOutput, Func<HttpContext, Task<bool>> shouldNext = null,
            Action<ListenOptions> listenConfigure = null,
            string resp = MockPodResponse)
        {
            shouldNext ??= (_ => Task.FromResult(true));
            listenConfigure ??= (_ => { });

            _webHost = WebHost.CreateDefaultBuilder()
                .Configure(app => app.Run(async httpContext =>
                {
                    if (await shouldNext(httpContext).ConfigureAwait(false))
                    {
                        await httpContext.Response.WriteAsync(resp).ConfigureAwait(false);
                    }
                }))
                .UseKestrel(options => { options.Listen(IPAddress.Loopback, 0, listenConfigure); })
                .ConfigureLogging(logging =>
                {
                    logging.ClearProviders();

                    if (testOutput != null)
                    {
                        logging.AddTestOutput(testOutput);
                    }
                })
                .Build();

            _webHost.Start();
        }

        public Uri Uri => _webHost.ServerFeatures.Get<IServerAddressesFeature>().Addresses
            .Select(a => new Uri(a)).First();

        public void Dispose()
        {
            _webHost.StopAsync();
            _webHost.WaitForShutdown();
            _webHost.Dispose();
        }
    }
}
