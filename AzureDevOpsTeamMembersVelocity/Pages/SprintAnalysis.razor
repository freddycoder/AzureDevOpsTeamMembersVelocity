@page "/SprintAnalysis"
@inject NavigationManager NavManager
@inject VelocityService VelocityService
@inject DevOpsService DevOpsService

<h3>SprintAnalysis</h3>

@if (Sprint != null)
{
    <div class="row">
        <div class="col-md-4">
            <dl>
                <dt>Name</dt>
                <dd>@Sprint.Name</dd>

                <dt>Path</dt>
                <dd>@Sprint.Path</dd>
            </dl>
        </div>
        <div class="col-md-4">
            <dl>
                <dt>Start date</dt>
                <dd>@Sprint.Attributes?.StartDate</dd>

                <dt>Finish date</dt>
                <dd>@Sprint.Attributes?.FinishDate</dd>

                <dt>Timeframe</dt>
                <dd>@Sprint.Attributes?.TimeFrame</dd>
            </dl>
        </div>
        <div class="col-md-4">
            <dl>
                <dt>Total days</dt>
                <dd>@Sprint.GetTotalDays()</dd>
            </dl>

            @if (TeamSettings != null)
            {
                <dl>
                    <dt>Total working days</dt>
                    <dd>@Sprint.GetTotalWorkingDays(TeamSettings.WorkingDays, TeamDaysOff)</dd>
                </dl>
            }
        </div>
    </div>
}
else
{
    <div>
        <p>Loading sprint information...</p>
    </div>
}


@if (MembersVelocities != null)
{
    <h3>Velocity table</h3>

    <table class="table table-striped table-hover table-responsive-md">
        <thead>
            <tr>
                <th>Person</th>
                <th>Hours of work done</th>
                <th>Estimated Capacity</th>
                <th>Real capacity</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var velocity in MembersVelocities.OrderByDescending(v => v.HoursOfWorkDone))
            {
                var updates = velocity.Updates;

                <tr>
                    <td>@velocity.DisplayName</td>
                    <td>@velocity.HoursOfWorkDone</td>
                    <td>@velocity.CapacitySaved</td>
                    <td>@velocity.RealCapacity.ToString("F2")</td>
                    <td>
                        <button class="btn btn-primary" @onclick="() => ShowUpdates(updates)">Show history</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <div>
        <p>Building velocity table ...</p>
    </div>
}

@code {
    [CascadingParameter]
    public IModalService? Modal { get; set; }

    public Sprint? Sprint { get; set; }

    public List<Capacity>? Capacities { get; set; }

    public Microsoft.TeamFoundation.Work.WebApi.TeamSetting? TeamSettings { get; set; }

    public Microsoft.TeamFoundation.Work.WebApi.TeamSettingsDaysOff? TeamDaysOff { get; set; }

    public HashSet<MemberVelocity>? MembersVelocities { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);

        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("sprints", out var sprintUrl))
        {
            Sprint = await DevOpsService.Sprint(sprintUrl);

            StateHasChanged();

            if (Sprint != null)
            {
                if (string.IsNullOrWhiteSpace(Sprint.Links?.Capacity?.Href) == false)
                {
                    Capacities = (await DevOpsService.Capacities(Sprint.Links.Capacity.Href))?.Value;
                }

                if (string.IsNullOrWhiteSpace(Sprint.Links?.TeamDaysOff?.Href) == false)
                {
                    TeamDaysOff = await DevOpsService.TeamDaysOff(Sprint.Links.TeamDaysOff.Href);
                }

                if (string.IsNullOrWhiteSpace(Sprint.Links?.TeamSettings?.Href) == false)
                {
                    TeamSettings = await DevOpsService.TeamSettings(Sprint.Links.TeamSettings.Href);

                    if (TeamSettings != null) StateHasChanged();
                }

                MembersVelocities = new HashSet<MemberVelocity>();

                await foreach (var velocity in VelocityService.MemberVelocities(sprintUrl, Capacities, Sprint, TeamDaysOff, TeamSettings))
                {
                    MembersVelocities.Add(velocity);
                    StateHasChanged();
                }
            }
        }
    }

    private void ShowUpdates(List<WorkItemUpdate> updates)
    {
        var parameters = new ModalParameters();

        parameters.Add("Updates", updates);

        Modal?.Show<PersonHistoryModal>("Update history", parameters);
    }
}
