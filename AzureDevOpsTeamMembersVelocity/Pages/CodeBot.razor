@page "/CodeBot"
@using AutoCode
@inject ILogger<CodeBot> Logger
<h3>CodeBot</h3>

<div class="row">
    <label>Choose a file</label>
    <InputFile OnChange="LoadFiles"></InputFile>
</div>

<div class="row">
    <textarea class="input-group-text" @bind="Code"></textarea>
</div>

@code { 
    public string? Code { get; set; }


    private List<IBrowserFile> loadedFiles = new();
    private long maxFileSize = 1024 * 15;
    private int maxAllowedFiles = 1;
    private bool isLoading;

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isLoading = true;
        loadedFiles.Clear();

        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            try
            {
                loadedFiles.Add(file);

                using var sr = new StreamReader(file.OpenReadStream(maxFileSize));

                var code = await sr.ReadToEndAsync();

                try
                {
                    Code = Automaticly.Add.Comment.To.Code(code);
                }
                catch (Exception exception)
                {
                    Code = exception.Message;
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("File: {Filename} Error: {Error}", file.Name, ex.Message);
            }
        }

        isLoading = false;
    }
}
